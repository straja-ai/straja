<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow, noarchive" />
  <title>Straja Console</title>
  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin: 0; padding: 16px; background: #f5f5f7; }
    .container { max-width: 1100px; margin: 0 auto; background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.06); }
    h1 { margin-top: 0; font-size: 22px; }
    .config { display: grid; grid-template-columns: 1fr 1fr; gap: 12px 16px; margin-bottom: 16px; }
    .config .full { grid-column: 1 / -1; }
    label { display: block; font-size: 13px; margin-bottom: 4px; color: #444; }
    input, textarea, select { width: 100%; padding: 8px 10px; border-radius: 8px; border: 1px solid #d0d0d7; font-size: 14px; }
    input[readonly], input:disabled { background: #f3f4f6; color: #6b7280; cursor: not-allowed; }
    textarea { resize: vertical; min-height: 80px; }
    .prompt-row { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 16px; }
    .prompt-row textarea { flex: 1; }
    .actions { display: flex; flex-direction: column; gap: 8px; min-width: 120px; }
    button { padding: 8px 12px; border-radius: 8px; border: none; font-size: 14px; cursor: pointer; background: #111827; color: #fff; }
    button:disabled { opacity: 0.6; cursor: default; }
    .stop-btn { background: #b91c1c; }
    .stop-btn:hover { background: #991b1b; }
    .toggle-row { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; color: #374151; }
    .toggle-row input { width: auto; }
    .status { font-size: 12px; color: #555; min-height: 16px; }
    .results { display: grid; grid-template-columns: 1.2fr 1fr; gap: 16px; margin-top: 8px; }
    .card { border-radius: 10px; border: 1px solid #e3e3ec; padding: 12px; background: #fafafa; overflow: hidden; }
    .card h2 { margin: 0 0 6px; font-size: 14px; }
    pre { margin: 0; font-size: 12px; overflow: auto; max-height: 260px; background: #f3f4f6; padding: 8px; border-radius: 8px; white-space: pre-wrap; word-break: break-word; }
    .assistant-output { margin-top: 8px; padding: 8px; background: #eff6ff; border-radius: 8px; font-size: 13px; min-height: 32px; white-space: pre-wrap; }
        .output-block {
      position: relative;
      margin-top: 8px;
    }
    .json-output { margin-top: 8px; padding: 8px; background: #f3f4f6; border-radius: 8px; font-size: 13px; min-height: 32px; white-space: pre-wrap; }
        .output-block {
      position: relative;
      margin-top: 8px;
    }

    .output-block pre,
    .output-block .assistant-output {
      padding-right: 40px; /* space for copy chip on the right */
    }

    .copy-chip {
      position: absolute;
      top: 6px;
      right: 6px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      font-size: 11px;
      color: #374151;
      cursor: pointer;
    }

    .copy-chip:hover {
      background: #e5e7eb;
    }

    .copy-icon {
      width: 14px;
      height: 14px;
      display: inline-block;
    }

    .copy-icon svg {
      width: 100%;
      height: 100%;
      fill: #6b7280;
    }
    .small { font-size: 11px; color: #777; }
    @media (max-width: 900px) {
      .config, .results { grid-template-columns: 1fr; }
    }
    @media (max-width: 640px) {
      body { padding: 10px; }
      .container { padding: 16px; border-radius: 10px; }
      .header { flex-direction: column; align-items: flex-start; gap: 6px; }
      .logo-mark { height: 20px; }
      h1 { font-size: 20px; }
      .prompt-row { flex-direction: column; }
      .actions { width: 100%; flex-direction: column; }
      .actions button { width: 100%; }
      .status { width: 100%; }
      textarea { min-height: 120px; }
    }
    .copy-row {
      display: flex;
      gap: 6px;
      justify-content: flex-end;
      margin-bottom: 4px;
    }
    .copy-btn {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #d0d0d7;
      background: #f3f4f6;
      color: #111827;
      cursor: pointer;
    }
    .copy-btn:hover {
      background: #e5e7eb;
    }
    .logo-mark {
      height: 24px;    /* tweak to taste: 24–32px works well */
      width: auto;
      display: block;
    }
    .header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .header h1 {
      margin: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="/console/static/img/straja-mark.svg" alt="Straja logo" class="logo-mark">
      <h1>Straja Dev Console</h1>
    </div>

    <div class="config">
        <div class="full">
            <label for="gatewayUrl">Console API base URL</label>
            <input
            id="gatewayUrl"
            type="text"
            value="/console/api"
            />
        </div>
        <div>
            <label for="projectSelect">Project</label>
            <select id="projectSelect">
            <option value="">Loading projects…</option>
            </select>
        </div>
        <div>
            <label for="model">Model</label>
            <input
            id="model"
            type="text"
            readonly
            disabled
            value="gpt-4.1-mini"
            />
        </div>
    </div>

    <div class="prompt-row">
      <textarea
        id="prompt"
        placeholder="Type your prompt here…"
      ></textarea>
      <div class="actions">
        <button id="sendBtn">Send</button>
        <button id="stopBtn" type="button" class="stop-btn" disabled>Stop</button>
        <button id="clearBtn" type="button">Clear</button>
        <label class="toggle-row">
          <input id="streamToggle" type="checkbox" />
          Streaming
        </label>
        <div class="status" id="status"></div>
      </div>
    </div>

    <div class="results">
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h2>Completion</h2>
          <div
            id="decisionStatus"
            style="
              font-size: 11px;
              padding: 4px 8px;
              border-radius: 6px;
              background: #eef2ff;
              border: 1px solid #c7d2fe;
              color: #3730a3;
              display: none;
            "
          ></div>
        </div>

        <!-- Assistant text with copy chip -->
        <div class="output-block">
        <div class="assistant-output" id="assistantText"></div>
        <button type="button" class="copy-chip" id="copyAssistantBtn">
            <span class="copy-icon">
            <svg viewBox="0 0 24 24" aria-hidden="true">
                <rect x="9" y="9" width="11" height="11" rx="2" ry="2"></rect>
                <rect x="4" y="4" width="11" height="11" rx="2" ry="2"></rect>
            </svg>
            </span>
            <span>Copy</span>
        </button>
        </div>

        <div class="small">Raw response</div>

        <!-- Raw JSON with copy chip -->
        <div class="output-block">
        <div class="json-output" id="completionJson"></div>
        <button type="button" class="copy-chip" id="copyCompletionBtn">
            <span class="copy-icon">
            <svg viewBox="0 0 24 24" aria-hidden="true">
                <rect x="9" y="9" width="11" height="11" rx="2" ry="2"></rect>
                <rect x="4" y="4" width="11" height="11" rx="2" ry="2"></rect>
            </svg>
            </span>
            <span>Copy</span>
        </button>
        </div>
    </div>

    <div class="card">
        <h2>Activation event</h2>
        <div class="small">
        Reads JSON from response header
        <code>X-Straja-Activation</code>.
        </div>

        <!-- Activation JSON with copy chip -->
        <div class="output-block">
        <div class="json-output" id="activationJson"></div>
        <button type="button" class="copy-chip" id="copyActivationBtn">
            <span class="copy-icon">
            <svg viewBox="0 0 24 24" aria-hidden="true">
                <rect x="9" y="9" width="11" height="11" rx="2" ry="2"></rect>
                <rect x="4" y="4" width="11" height="11" rx="2" ry="2"></rect>
            </svg>
            </span>
            <span>Copy</span>
        </button>
        </div>
    </div>
    </div>
  </div>

    <script>
    const gatewayUrlInput = document.getElementById('gatewayUrl');
    const projectSelect = document.getElementById('projectSelect');
    const modelInput = document.getElementById('model');
    const promptInput = document.getElementById('prompt');
    const sendBtn = document.getElementById('sendBtn');
    const stopBtn = document.getElementById('stopBtn');
    const clearBtn = document.getElementById('clearBtn');
    const streamToggle = document.getElementById('streamToggle');
    streamToggle.checked = true;
    const statusEl = document.getElementById('status');
    const completionJsonEl = document.getElementById('completionJson');
    const activationJsonEl = document.getElementById('activationJson');
    const assistantTextEl = document.getElementById('assistantText');

    const copyAssistantBtn = document.getElementById('copyAssistantBtn');
    const copyCompletionBtn = document.getElementById('copyCompletionBtn');
    const copyActivationBtn = document.getElementById('copyActivationBtn');

    const STORAGE_KEY = 'strajaConsoleConfig';

    async function copyFromElement(el) {
      const text = (el && (el.textContent || el.value || '')).trim();
      if (!text) {
        statusEl.textContent = 'Nothing to copy.';
        statusEl.style.color = '#b91c1c'; // red
        setTimeout(() => {
          statusEl.textContent = '';
          statusEl.style.color = '';
        }, 3000);
        return;
      }

      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
        } else {
          const tmp = document.createElement('textarea');
          tmp.value = text;
          tmp.style.position = 'fixed';
          tmp.style.left = '-9999px';
          document.body.appendChild(tmp);
          tmp.focus();
          tmp.select();
          document.execCommand('copy');
          document.body.removeChild(tmp);
        }

        statusEl.textContent = 'Copied to clipboard.';
        statusEl.style.color = '#16a34a'; // green
        setTimeout(() => {
          statusEl.textContent = '';
          statusEl.style.color = '';
        }, 3000);
      } catch (err) {
        console.error('Copy failed', err);
        statusEl.textContent = 'Copy failed.';
        statusEl.style.color = '#b91c1c'; // red
        setTimeout(() => {
          statusEl.textContent = '';
          statusEl.style.color = '';
        }, 3000);
      }
    }

    function loadConfig() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const cfg = JSON.parse(raw);
        if (cfg.baseUrl) gatewayUrlInput.value = cfg.baseUrl;
        if (cfg.model) modelInput.value = cfg.model;
        if (cfg.projectId) {
          // we'll select this after projects load
          projectSelect.dataset.selected = cfg.projectId;
        }
        if (typeof cfg.streaming === 'boolean') {
          streamToggle.checked = cfg.streaming;
        }
      } catch (_) {}
    }

    function saveConfig() {
      const cfg = {
        baseUrl: gatewayUrlInput.value.trim(),
        model: modelInput.value.trim(),
        projectId: projectSelect.value,
        streaming: streamToggle.checked
      };
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(cfg));
      } catch (_) {}
    }

    async function loadProjects() {
      const baseUrl = gatewayUrlInput.value.trim() || '/console/api';
      try {
        const res = await fetch(baseUrl + '/projects');
        if (!res.ok) {
          projectSelect.innerHTML = '<option value="">Error loading projects</option>';
          return;
        }
        const projects = await res.json();
        if (!Array.isArray(projects) || projects.length === 0) {
          projectSelect.innerHTML = '<option value="">No projects in config</option>';
          return;
        }
        projectSelect.innerHTML = '';
        const storedId = projectSelect.dataset.selected;
        projects.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.id + (p.provider ? ` (${p.provider})` : '');
          projectSelect.appendChild(opt);
        });
        if (storedId) {
          const found = Array.from(projectSelect.options).some(o => o.value === storedId);
          if (found) {
            projectSelect.value = storedId;
          }
        }
      } catch (err) {
        projectSelect.innerHTML = '<option value="">Error loading projects</option>';
      }
    }

    let activeController = null;

    async function sendRequest() {
      if (streamToggle.checked) {
        await sendStreamRequest();
        return;
      }
      await sendNonStreamRequest();
    }

    async function sendNonStreamRequest() {
      const baseUrl = gatewayUrlInput.value.trim() || '/console/api';
      const projectId = projectSelect.value;
      const model = modelInput.value.trim() || 'gpt-4.1-mini';
      const prompt = promptInput.value.trim();

      if (!projectId) {
        statusEl.textContent = 'Please select a project.';
        return;
      }
      if (!prompt) {
        statusEl.textContent = 'Please enter a prompt.';
        return;
      }

      saveConfig();

      sendBtn.disabled = true;
      stopBtn.disabled = true;
      clearBtn.disabled = true;
      statusEl.textContent = 'Sending request…';
      completionJsonEl.textContent = '';
      activationJsonEl.textContent = '';
      assistantTextEl.textContent = '';

      const body = {
        project_id: projectId,
        model: model,
        messages: [
          { role: 'user', content: prompt }
        ]
      };

      try {
        const res = await fetch(baseUrl + '/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });

        const text = await res.text();
        let json;
        try {
          json = JSON.parse(text);
        } catch (_) {
          completionJsonEl.textContent = text;
          assistantTextEl.textContent = '';
        }

        if (json) {
          completionJsonEl.textContent = JSON.stringify(json, null, 2);

          const assistantMessage =
            json.choices &&
            json.choices[0] &&
            json.choices[0].message &&
            json.choices[0].message.content;

          assistantTextEl.textContent = assistantMessage || '(no assistant message found)';
        }

        applyActivationHeader(res.headers.get('x-straja-activation'));

        statusEl.textContent = `HTTP ${res.status} ${res.statusText}`;
      } catch (err) {
        statusEl.textContent = 'Error: ' + (err && err.message ? err.message : String(err));
        completionJsonEl.textContent = '';
        activationJsonEl.textContent = '';
        assistantTextEl.textContent = '';

        const decisionEl = document.getElementById('decisionStatus');
        if (decisionEl) {
          decisionEl.style.display = 'none';
          decisionEl.textContent = '';
        }
      } finally {
        sendBtn.disabled = false;
        stopBtn.disabled = true;
        clearBtn.disabled = false;
      }
    }

    async function sendStreamRequest() {
      const baseUrl = gatewayUrlInput.value.trim() || '/console/api';
      const projectId = projectSelect.value;
      const model = modelInput.value.trim() || 'gpt-4.1-mini';
      const prompt = promptInput.value.trim();

      if (!projectId) {
        statusEl.textContent = 'Please select a project.';
        return;
      }
      if (!prompt) {
        statusEl.textContent = 'Please enter a prompt.';
        return;
      }

      saveConfig();

      sendBtn.disabled = true;
      stopBtn.disabled = false;
      clearBtn.disabled = true;
      statusEl.textContent = 'Streaming…';
      completionJsonEl.textContent = '';
      activationJsonEl.textContent = '';
      assistantTextEl.textContent = '';

      const body = {
        project_id: projectId,
        model: model,
        stream: true,
        messages: [
          { role: 'user', content: prompt }
        ]
      };

      const controller = new AbortController();
      activeController = controller;

      let rawSSE = '';
      let assistantText = '';

      try {
        const res = await fetch(baseUrl + '/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'text/event-stream'
          },
          body: JSON.stringify(body),
          signal: controller.signal
        });

        applyActivationHeader(res.headers.get('x-straja-activation'));

        if (!res.ok || !res.body) {
          const errText = await res.text();
          statusEl.textContent = `HTTP ${res.status} ${res.statusText}`;
          completionJsonEl.textContent = errText;
          stopBtn.disabled = true;
          return;
        }

        const reader = res.body.getReader();
        const decoder = new TextDecoder('utf-8');
        let buffer = '';
        let done = false;

        while (!done) {
          const { value, done: readDone } = await reader.read();
          done = readDone;
          if (value) {
            buffer += decoder.decode(value, { stream: true });
            let idx;
            while ((idx = buffer.indexOf('\n\n')) !== -1) {
              const chunk = buffer.slice(0, idx);
              buffer = buffer.slice(idx + 2);
              if (!chunk.trim()) {
                continue;
              }
              rawSSE += chunk + '\n\n';
              const delta = extractDeltaFromSSE(chunk);
              if (delta) {
                assistantText += delta;
                assistantTextEl.textContent = assistantText;
              }
              completionJsonEl.textContent = rawSSE;
            }
          }
        }

        statusEl.textContent = 'Streaming complete';
      } catch (err) {
        if (err && err.name === 'AbortError') {
          statusEl.textContent = 'Streaming stopped';
        } else {
          statusEl.textContent = 'Error: ' + (err && err.message ? err.message : String(err));
        }
      } finally {
        sendBtn.disabled = false;
        stopBtn.disabled = true;
        clearBtn.disabled = false;
        activeController = null;
      }
    }

    function extractDeltaFromSSE(chunk) {
      const lines = chunk.split('\n');
      const dataLines = [];
      for (const line of lines) {
        if (line.startsWith('data:')) {
          dataLines.push(line.slice(5).trimStart());
        }
      }
      if (dataLines.length === 0) return '';
      const data = dataLines.join('\n');
      if (data === '[DONE]') return '';
      try {
        const obj = JSON.parse(data);
        if (obj && typeof obj === 'object') {
          if (typeof obj.delta === 'string') return obj.delta;
          if (typeof obj.text === 'string') return obj.text;
          if (typeof obj.output_text === 'string') return obj.output_text;
          if (obj.delta && typeof obj.delta.text === 'string') return obj.delta.text;
        }
      } catch (_) {
        return '';
      }
      return '';
    }

    function applyActivationHeader(activationHeader) {
      const decisionEl = document.getElementById('decisionStatus');

      if (decisionEl) {
        decisionEl.style.display = 'none';
        decisionEl.textContent = '';
        decisionEl.style.background = '#eef2ff';
        decisionEl.style.border = '1px solid #c7d2fe';
        decisionEl.style.color = '#3730a3';
      }

      if (activationHeader) {
        try {
          const actJson = JSON.parse(activationHeader);
          activationJsonEl.textContent = JSON.stringify(actJson, null, 2);

          const policyHits = Array.isArray(actJson.policy_hits)
            ? actJson.policy_hits
                .map(h => (typeof h === 'string' ? h : h.category))
                .filter(Boolean)
            : Array.isArray(actJson.policy_hit_categories)
              ? actJson.policy_hit_categories.filter(Boolean)
              : [];

          if (decisionEl && actJson.decision) {
            let d = String(actJson.decision);
            if (d === 'allow' && policyHits.some(h => h !== 'toxicity')) {
              d = 'redacted';
            }

            decisionEl.textContent = d;
            decisionEl.style.display = 'inline-block';

            if (d.startsWith('blocked')) {
              decisionEl.style.background = '#fee2e2';
              decisionEl.style.border = '1px solid #fecaca';
              decisionEl.style.color = '#b91c1c';
            } else if (d === 'allow') {
              decisionEl.style.background = '#dcfce7';
              decisionEl.style.border = '1px solid #bbf7d0';
              decisionEl.style.color = '#166534';
            } else if (d === 'redacted') {
              decisionEl.style.background = '#fef9c3';
              decisionEl.style.border = '1px solid #fef08a';
              decisionEl.style.color = '#854d0e';
            } else {
              decisionEl.style.background = '#e5e7eb';
              decisionEl.style.border = '1px solid #d1d5db';
              decisionEl.style.color = '#374151';
            }
          }
        } catch (_) {
          activationJsonEl.textContent = activationHeader;
        }
      } else {
        activationJsonEl.textContent = '(no activation header present)';
      }
    }

    function clearAll() {
      promptInput.value = '';
      completionJsonEl.textContent = '';
      activationJsonEl.textContent = '';
      assistantTextEl.textContent = '';
      statusEl.textContent = '';

      const decisionEl = document.getElementById('decisionStatus');
      if (decisionEl) {
        decisionEl.style.display = 'none';
        decisionEl.textContent = '';
      }
    }

    sendBtn.addEventListener('click', sendRequest);
    clearBtn.addEventListener('click', clearAll);
    stopBtn.addEventListener('click', () => {
      if (activeController) {
        activeController.abort();
      }
    });
    promptInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        sendRequest();
      }
    });

    copyAssistantBtn.addEventListener('click', () => copyFromElement(assistantTextEl));
    copyCompletionBtn.addEventListener('click', () => copyFromElement(completionJsonEl));
    copyActivationBtn.addEventListener('click', () => copyFromElement(activationJsonEl));

    loadConfig();
    loadProjects();
  </script>
</body>
</html>
